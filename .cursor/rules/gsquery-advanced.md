# gsquery â€” Migration, CLI & Client

## Migration System

```ts
import { createMigrationRunner, MockAdapter } from '@gsquery/core'
import type { MigrationRecord } from '@gsquery/core'

const runner = createMigrationRunner({
  migrationsStore: new MockAdapter<MigrationRecord>(),
  storeResolver: (tableName) => db.getStore(tableName),
  migrations: [
    {
      version: 1,
      name: 'add-role-column',
      up: (schema) => schema.addColumn('users', 'role', { default: 'viewer' }),
      down: (schema) => schema.removeColumn('users', 'role'),
    },
  ],
})

// Run all pending
await runner.migrate()

// Run to specific version
await runner.migrate({ to: 1 })

// Rollback last / all
await runner.rollback()
await runner.rollbackAll()

// Status
runner.getCurrentVersion()       // number
runner.getPendingMigrations()    // Migration[]
runner.getAppliedMigrations()    // MigrationRecord[]
```

### SchemaBuilder Operations

```ts
schema.addColumn(table, column, { default?: value, type?: 'string'|'number'|'boolean'|'date' })
schema.removeColumn(table, column)
schema.renameColumn(table, oldName, newName)
```

---

## @gsquery/cli

```bash
gsquery init [directory]                          # Create project with schema template
gsquery generate <schema-file> [-o dir] [--watch] # Generate types + client
gsquery migrate [--to version] [--config path]    # Run migrations
gsquery rollback [--all] [--config path]          # Rollback migrations
gsquery migration:create <name>                   # Create migration file
```

### Schema (.gsq.yaml)

```yaml
enums:
  Role: [admin, editor, viewer]

tables:
  User:
    mapTo: Users
    fields:
      id: { type: number, attributes: ["@id"] }
      name: { type: string }
      email: { type: string, attributes: ["@unique"] }
      role: { type: Role, attributes: ["@default(viewer)"] }
    blockAttributes: ["@@index([email])"]
```

**Field types**: `string`, `number`, `boolean`, `datetime`, `string[]`, `number[]`, enum names.

**Attributes**: `@id`, `@unique`, `@default(value)`, `@default(autoincrement|now|uuid)`, `@updatedAt`, `@relation(Table)`.

**Block attributes**: `@@index([fields])`, `@@unique([fields])`, `@@map(sheetName)`.

---

## @gsquery/client

```ts
import { createClientFactory } from '@gsquery/client'

const factory = createClientFactory<Tables>(generatedSchema)

// Production
const db = factory({ spreadsheetId: 'abc123' })

// Testing
const db = factory({ mock: true })
```

Environment detection: `isGASEnvironment()`, `isNodeEnvironment()`.

## Common Mistakes

- Migration versions must be unique positive integers
- Always implement `down()` for rollback support
- Run `gsquery init` before `gsquery generate`
- `createClientFactory` requires a schema generated by the CLI
